#!/usr/bin/env python
#
# Generate a cloud config file that performs the following operations:
# - mount an ephemeral partition
# - write and execute the cloud scheduler configuration script
#
# Note: This needs to be compatible with cloud-init 0.6.3, which means
#       no "write_files" module (hence multi-line cat shenanigans in runcmd)

import re

# file names
script = 'cloud_scheduler_setup.bash'
output_yml = 'cloud_config.yml'
pubkey = 'canfarcs_id_rsa.pub'

# load script content
script_content_raw = open(script,'r').readlines()
script_content = "".join("      "+l for l in script_content_raw)

# load canfarcs pubkey
pubkey_content = open(pubkey,'r').read().strip()

# obtain the mount point for the ephemeral partition from the script
ephemeral_dir = re.search("EPHEMERAL_DIR\s*=\s*[\'\"]([^\'\"]+)",
                          script_content).group(1)

start_text = '''#cloud-config
# DO NOT EDIT THIS FILE: generated make_cloud_config

ssh_authorized_keys:
  - %s

# Normally wouldn't bother with arguments beyond /ephemeral,
# but defaults didn't work with SL5
mounts:
  - [ ephemeral0, %s, auto, defaults, 0, 0 ]

runcmd:
  - |
      cat - > /tmp/%s <<'EOF'
''' % (pubkey_content,ephemeral_dir,script)

end_text = '''
      EOF
  - [ 'chmod', '0755', '/tmp/%s' ]
  - [ '/tmp/%s','--update-cloud-scheduler' ]
''' % (script,script)

f = open(output_yml,'w')
f.write(start_text)
f.write(script_content)
f.write(end_text)
f.close()
